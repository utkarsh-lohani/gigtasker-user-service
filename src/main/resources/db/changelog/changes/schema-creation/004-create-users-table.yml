databaseChangeLog:
  - changeSet:
      id: create-gig-users-table
      author: utkarsh.lohani
      changes:

        # Main gig_users table
        - createTable:
            tableName: gig_users
            columns:
              - column:
                  name: id
                  type: BIGINT
                  autoIncrement: true
                  constraints:
                    primaryKey: true
                    nullable: false

              - column:
                  name: keycloak_id
                  type: UUID
                  constraints:
                    nullable: false
                    unique: true

              - column:
                  name: username
                  type: VARCHAR(255)
                  constraints:
                    nullable: false
                    unique: true

              - column:
                  name: email
                  type: VARCHAR(255)
                  constraints:
                    nullable: false
                    unique: true

              - column:
                  name: first_name
                  type: VARCHAR(255)

              - column:
                  name: last_name
                  type: VARCHAR(255)

              - column:
                  name: is_deleted
                  type: BOOLEAN
                  defaultValueBoolean: false
                  constraints:
                    nullable: false

              - column:
                  name: date_of_birth
                  type: DATE

              - column:
                  name: gender_id
                  type: BIGINT

              - column:
                  name: country_id
                  type: BIGINT

              - column:
                  name: profile_image_url
                  type: text

        # Foreign key gender_id → genders.id
        - addForeignKeyConstraint:
            baseTableName: gig_users
            baseColumnNames: gender_id
            referencedTableName: genders
            referencedColumnNames: id
            constraintName: fk_user_gender
            onDelete: SET NULL

        # Foreign key country_id → countries.id
        - addForeignKeyConstraint:
            baseTableName: gig_users
            baseColumnNames: country_id
            referencedTableName: countries
            referencedColumnNames: id
            constraintName: fk_user_country
            onDelete: SET NULL

        # Indexes for lookup performance
        - createIndex:
            indexName: idx_users_username
            tableName: gig_users
            columns:
              - column:
                  name: username

        - createIndex:
            indexName: idx_users_email
            tableName: gig_users
            columns:
              - column:
                  name: email

        - createIndex:
            indexName: idx_users_keycloak_id
            tableName: gig_users
            columns:
              - column:
                  name: keycloak_id

        - createIndex:
            indexName: idx_users_gender_id
            tableName: gig_users
            columns:
              - column:
                  name: gender_id

        - createIndex:
            indexName: idx_users_country_id
            tableName: gig_users
            columns:
              - column:
                  name: country_id

        - createIndex:
            indexName: idx_users_is_deleted
            tableName: gig_users
            columns:
              - column:
                  name: is_deleted

  # ------------------------------------------
  # MANY-TO-MANY: users_roles join table
  # ------------------------------------------
  - changeSet:
      id: create-users-roles-table
      author: yourname
      changes:
        - createTable:
            tableName: users_roles
            columns:
              - column:
                  name: user_id
                  type: BIGINT
                  constraints:
                    nullable: false

              - column:
                  name: role_id
                  type: BIGINT
                  constraints:
                    nullable: false

        - addPrimaryKey:
            tableName: users_roles
            columnNames: user_id, role_id
            constraintName: pk_users_roles

        - addForeignKeyConstraint:
            baseTableName: users_roles
            baseColumnNames: user_id
            referencedTableName: gig_users
            referencedColumnNames: id
            constraintName: fk_users_roles_user
            onDelete: CASCADE

        - addForeignKeyConstraint:
            baseTableName: users_roles
            baseColumnNames: role_id
            referencedTableName: roles
            referencedColumnNames: id
            constraintName: fk_users_roles_role
            onDelete: CASCADE

        - createIndex:
            indexName: idx_users_roles_user
            tableName: users_roles
            columns:
              - column:
                  name: user_id

        - createIndex:
            indexName: idx_users_roles_role
            tableName: users_roles
            columns:
              - column:
                  name: role_id

      rollback:
        - dropIndex:
            tableName: users_roles
            indexName: idx_users_roles_role

        - dropIndex:
            tableName: users_roles
            indexName: idx_users_roles_user

        - dropForeignKeyConstraint:
            baseTableName: users_roles
            constraintName: fk_users_roles_role

        - dropForeignKeyConstraint:
            baseTableName: users_roles
            constraintName: fk_users_roles_user

        - dropTable:
            tableName: users_roles

  # ------------------------------------------
  # ROLLBACK for gig_users table
  # ------------------------------------------
  - changeSet:
      id: rollback-gig-users
      author: yourname
      changes: []
      rollback:
        - dropIndex:
            tableName: gig_users
            indexName: idx_users_is_deleted

        - dropIndex:
            tableName: gig_users
            indexName: idx_users_country_id

        - dropIndex:
            tableName: gig_users
            indexName: idx_users_gender_id

        - dropIndex:
            tableName: gig_users
            indexName: idx_users_keycloak_id

        - dropIndex:
            tableName: gig_users
            indexName: idx_users_email

        - dropIndex:
            tableName: gig_users
            indexName: idx_users_username

        - dropForeignKeyConstraint:
            baseTableName: gig_users
            constraintName: fk_user_country

        - dropForeignKeyConstraint:
            baseTableName: gig_users
            constraintName: fk_user_gender

        - dropTable:
            tableName: gig_users
